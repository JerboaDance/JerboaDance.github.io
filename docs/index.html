<html>
  <head>
    <meta http-equiv='content-language' content='en-US'>
    <link rel="icon" type="image/png" href="/assets/logos/logo-black.jpg" />
    <link rel="stylesheet" href="/css/main.css"/>
    <title>Jerboa Dance - Acrobatic Contemporary Dance | Seattle</title>
    <script src="/scripts/common.js" type="module"></script>
    <script type="module">
      import { shows } from "/scripts/database.js";
      import { 
        findCurrentShow,
        populateHeaderImage,
        populateVenue,
        populateEventbriteWidget,
        populateTicketTiers,
        populateShowtimes,
        populateCastList,
      } from "/scripts/shows.js";
      import generateYouTubeEmbed from "/scripts/youTube.js"
      
      function populateCurrentPerformance(currentShow, currentPerformance) {
        const { dates, venue, eventbriteId, ticketTiers, showtimes, emcee, highlights, companyMembers } = currentPerformance;

        // Check if show has videos - display video instead of image
        if (currentShow.videos && currentShow.videos.length > 0) {
          const headerImageContainer = document.querySelector('.header-image');
          headerImageContainer.innerHTML = ''; // Clear the img element
          
          const playerId = 'header-video-player';
          const videoEmbed = generateYouTubeEmbed(
            currentShow.videos[0],
            { autoplay: true, muted: true, playerId: playerId }
          );
          headerImageContainer.appendChild(videoEmbed);
          
          // Load YouTube IFrame API if not already loaded
          if (!window.YT) {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            document.head.appendChild(tag);
          }
          
          // Setup player to listen for video end
          const setupPlayer = () => {
            new YT.Player(playerId, {
              events: {
                'onStateChange': (event) => {
                  // YT.PlayerState.ENDED = 0
                  if (event.data === 0) {
                    // Video ended - switch to image
                    headerImageContainer.innerHTML = '';
                    const headerImage = document.createElement('img');
                    headerImage.id = 'headerImage';
                    headerImageContainer.appendChild(headerImage);
                    populateHeaderImage(headerImage, currentShow);
                  }
                }
              }
            });
          };
          
          // Wait for API to be ready
          if (window.YT && window.YT.Player) {
            setupPlayer();
          } else {
            window.onYouTubeIframeAPIReady = setupPlayer;
          }
        } else {
          const headerImage = document.getElementById("headerImage");
          populateHeaderImage(headerImage, currentShow);
        }
        
        const eventbriteElement = document.getElementById("currentBptWidget");
        populateEventbriteWidget(eventbriteElement, eventbriteId);

        const nameElement = document.getElementById("name");
        nameElement.innerText = currentShow.name;

        const datesElement = document.getElementById("currentDates");
        datesElement.innerText = dates;

        const venueElement = document.getElementById("currentVenue");
        populateVenue(venueElement, venue);

        const descriptionElement = document.getElementById("currentDescription");
        descriptionElement.innerHTML = currentShow.description;

        const ticketTierListElement = document.getElementById("currentTicketTiers");
        populateTicketTiers(ticketTierListElement, ticketTiers);

        const showtimesListElement = document.getElementById("currentShowtimes")
        populateShowtimes(showtimesListElement, showtimes);

        const castListElement = document.getElementById("currentCastList");
        populateCastList(castListElement, emcee, highlights, companyMembers);
      }

      function populatePage() {
        const mainElement = document.getElementById("main");
        
        const {currentShow, currentPerformance} = findCurrentShow(shows);
        if (currentPerformance) {
          populateCurrentPerformance(currentShow, currentPerformance);
        } else {
          const currentPerformanceElement = document.getElementById("currentPerformance");
          currentPerformanceElement.hidden = true;
          
          const headerImage = document.getElementById("headerImage");
          headerImage.src = `/assets/defaultIndexHeader.jpg`;
        }

        /* 
        const teaserVideo = document.createElement("div")
        teaserVideo.setAttribute("class", "teaser-video");
        teaserVideo.append(generateYouTubeEmbed({ id: "GSR_h1AcrU8", aspectRatio:"16x9"}));
        mainElement.append(teaserVideo); 
        */
      }
      populatePage();
    </script>
  </head>
  <body>
    <div class="bodyWrapper">
      <header id="header"></header>
      <div class="header-image"><img id="headerImage" /></div>
      <main id="main">
        <div id="currentPerformance">
          <h1 id="name"></h1>
          <h2 id="currentDates" class="show-dates"></h2>
          <h3 class="venue"><a id="currentVenue"></a></h3>
          <div id="currentBptWidget" class="tickets"></div>
          <p id="currentDescription"></p>
          <ul id="currentTicketTiers" class="ticket-tiers"></ul>
          <ul id="currentShowtimes" class="show-times"></ul>
          <ul id="currentCastList" class="cast-list"></ul>
        </div>
      </main>
      <footer id="footer"></footer>
    </div>
  </body>
</html>
