<html>
  <head>
    <meta http-equiv='content-language' content='en-US'>
    <link rel="icon" type="image/png" href="/assets/logos/logo-black.jpg" />
    <link rel="stylesheet" href="/css/main.css"/>
    <title>Jerboa Dance - Acrobatic Contemporary Dance | Seattle</title>
    <script src="/scripts/common.js" type="module"></script>
    <script type="module">
      import { shows } from "/scripts/database.js";
      import { 
        findCurrentShow,
        populateHeaderImage,
        populateVenue,
        populateEventbriteWidget,
        populateTicketTiers,
        populateShowtimes,
        populateCastList,
      } from "/scripts/shows.js";
      import generateYouTubeEmbed from "/scripts/youTube.js";
      import { getShowImageUrl } from "/scripts/urls.js";
      
      function populateCurrentPerformance(currentShow, currentPerformance) {
        const { dates, venue, eventbriteId, ticketTiers, showtimes, emcee, highlights, companyMembers } = currentPerformance;

        // Check if show has videos - display video instead of image
        if (currentShow.videos && currentShow.videos.length > 0) {
          const headerImageContainer = document.querySelector('.header-image');
          
          // Pre-load the header image so it's ready when video ends
          const preloadedImage = new Image();
          const imageUrl = getShowImageUrl(currentShow, currentShow.headerImage.filename);
          preloadedImage.src = imageUrl;
          preloadedImage.onload = () => {
            console.log('Header image preloaded and ready');
          };
          
          headerImageContainer.innerHTML = ''; // Clear the img element
          
          const playerId = 'header-video-player';
          const videoEmbed = generateYouTubeEmbed(
            currentShow.videos[0],
            { autoplay: true, muted: true, playerId: playerId }
          );
          headerImageContainer.appendChild(videoEmbed);
          
          // Set fixed height to prevent layout shift
          setTimeout(() => {
            const videoContainer = headerImageContainer.querySelector('.youtube');
            if (videoContainer) {
              const videoHeight = videoContainer.offsetHeight;
              headerImageContainer.style.minHeight = `${videoHeight}px`;
              headerImageContainer.style.transition = 'opacity 0.5s ease-in-out';
              console.log('Container height set to:', videoHeight + 'px');
            }
          }, 100);
          
          // Function to switch to image with smooth transition
          const switchToImage = () => {
            console.log('Switching to header image');
            
            // Fade out
            headerImageContainer.style.opacity = '0';
            
            setTimeout(() => {
              headerImageContainer.innerHTML = '';
              const headerImage = document.createElement('img');
              headerImage.id = 'headerImage';
              headerImage.src = preloadedImage.src; // Use preloaded image
              headerImage.style.width = '100%';
              headerImage.style.height = 'auto';
              headerImageContainer.appendChild(headerImage);
              
              // Fade in
              setTimeout(() => {
                headerImageContainer.style.opacity = '1';
              }, 50);
            }, 500);
          };
          
          // Load YouTube IFrame API if not already loaded
          if (!window.YT) {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            document.head.appendChild(tag);
          }
          
          // Setup player to listen for video end
          const setupPlayer = () => {
            console.log('Setting up YouTube player...');
            try {
              const player = new YT.Player(playerId, {
                events: {
                  'onReady': (event) => {
                    console.log('YouTube player ready');
                  },
                  'onStateChange': (event) => {
                    console.log('YouTube state changed:', event.data);
                    // YT.PlayerState.ENDED = 0
                    if (event.data === 0) {
                      console.log('Video ended');
                      switchToImage();
                    }
                  },
                  'onError': (event) => {
                    console.error('YouTube player error:', event.data);
                  }
                }
              });
            } catch (error) {
              console.error('Error setting up YouTube player:', error);
            }
          };
          
          // Wait for API to be ready
          if (window.YT && window.YT.Player) {
            // API already loaded, wait a bit for iframe to be in DOM
            setTimeout(setupPlayer, 100);
          } else {
            window.onYouTubeIframeAPIReady = () => {
              // Wait a bit for iframe to be fully ready in DOM
              setTimeout(setupPlayer, 100);
            };
          }
        } else {
          const headerImage = document.getElementById("headerImage");
          populateHeaderImage(headerImage, currentShow);
        }
        
        const eventbriteElement = document.getElementById("currentBptWidget");
        populateEventbriteWidget(eventbriteElement, eventbriteId);

        const nameElement = document.getElementById("name");
        nameElement.innerText = currentShow.name;

        const datesElement = document.getElementById("currentDates");
        datesElement.innerText = dates;

        const venueElement = document.getElementById("currentVenue");
        populateVenue(venueElement, venue);

        const descriptionElement = document.getElementById("currentDescription");
        descriptionElement.innerHTML = currentShow.description;

        const ticketTierListElement = document.getElementById("currentTicketTiers");
        populateTicketTiers(ticketTierListElement, ticketTiers);

        const showtimesListElement = document.getElementById("currentShowtimes")
        populateShowtimes(showtimesListElement, showtimes);

        const castListElement = document.getElementById("currentCastList");
        populateCastList(castListElement, emcee, highlights, companyMembers);
      }

      function findMostRecentShow(shows) {
        let mostRecentShow = null;
        let mostRecentEndDate = 0;
        
        Object.keys(shows).forEach((showId) => {
          const show = shows[showId];
          if (show.performances?.length > 0) {
            const performance = show.performances[0];
            if (performance.endDate < Date.now() && performance.endDate > mostRecentEndDate) {
              mostRecentShow = show;
              mostRecentEndDate = performance.endDate;
            }
          }
        });
        
        return mostRecentShow;
      }
      
      function populateNoCurrentShow(mainElement) {
        const mostRecentShow = findMostRecentShow(shows);
        
        if (mostRecentShow) {
          // Most Recent Show Section
          const recentShowSection = document.createElement("div");
          recentShowSection.setAttribute("class", "recent-show-section");
          recentShowSection.innerHTML = `
            <h2>Our Most Recent Production</h2>
            <h1><a href="/show.html?showId=${mostRecentShow.id}">${mostRecentShow.name}</a></h1>
            <p>${mostRecentShow.shortDescription || mostRecentShow.description}</p>
          `;
          mainElement.append(recentShowSection);
        }
        
        // Stay Tuned Section
        const stayTunedSection = document.createElement("div");
        stayTunedSection.setAttribute("class", "stay-tuned-section");
        stayTunedSection.innerHTML = `
          <h2>Stay Connected</h2>
          <p>Thank you for your interest in Jerboa Dance! We're planning our next production. Check back soon for updates on upcoming performances.</p>
        `;
        mainElement.append(stayTunedSection);
        
        // YouTube Video Gallery
        const youtubeSection = document.createElement("div");
        youtubeSection.setAttribute("class", "youtube-gallery-section");
        youtubeSection.innerHTML = `
          <h2>Watch Our Performances</h2>
          <div class="youtube-embed-container">
            <iframe src="https://www.youtube.com/embed/videoseries?list=UU9bL2TfWQ0MyGwCgNws4h2w" 
                    width="100%" 
                    height="400" 
                    frameborder="0" 
                    allowfullscreen
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
            </iframe>
          </div>
        `;
        mainElement.append(youtubeSection);
      }

      function populatePage() {
        const mainElement = document.getElementById("main");
        
        const {currentShow, currentPerformance} = findCurrentShow(shows);
        if (currentPerformance) {
          populateCurrentPerformance(currentShow, currentPerformance);
        } else {
          const currentPerformanceElement = document.getElementById("currentPerformance");
          currentPerformanceElement.hidden = true;
          
          const headerImage = document.getElementById("headerImage");
          headerImage.src = `/assets/defaultIndexHeader.jpg`;
          
          populateNoCurrentShow(mainElement);
        }

        /* 
        const teaserVideo = document.createElement("div")
        teaserVideo.setAttribute("class", "teaser-video");
        teaserVideo.append(generateYouTubeEmbed({ id: "GSR_h1AcrU8", aspectRatio:"16x9"}));
        mainElement.append(teaserVideo); 
        */
      }
      populatePage();
    </script>
  </head>
  <body>
    <div class="bodyWrapper">
      <header id="header"></header>
      <div class="header-image"><img id="headerImage" /></div>
      <main id="main">
        <div id="currentPerformance">
          <h1 id="name"></h1>
          <h2 id="currentDates" class="show-dates"></h2>
          <h3 class="venue"><a id="currentVenue"></a></h3>
          <div id="currentBptWidget" class="tickets"></div>
          <p id="currentDescription"></p>
          <ul id="currentTicketTiers" class="ticket-tiers"></ul>
          <ul id="currentShowtimes" class="show-times"></ul>
          <ul id="currentCastList" class="cast-list"></ul>
        </div>
      </main>
      <footer id="footer"></footer>
    </div>
  </body>
</html>
