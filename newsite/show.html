<html>
  <head>
    <link rel="stylesheet" href="/css/main.css"/>
    <script src="/scripts/common.js" type="module"></script>
    <script type="module">
      import { shows } from "/scripts/database.js";
      import {
        populateVenue,
        populateBrownPaperTicketsWidget,
        populateTicketTiers,
        populateShowtimes,
        populateCastList,
        checkForUpcomingPerformance, 
        checkForPriorPerformances 
      } from "/scripts/shows.js";
      import { generateYouTubeEmbed } from "/scripts/youTube.js"
      

      function populateUpcomingPerformance(show) {
        const upcomingPerformance = show.performances[0];
        const { dates, venue, bptId, ticketTiers, showtimes, emcee, highlights, companyMembers } = upcomingPerformance;

        const datesElement = document.getElementById("upcomingDates");
        datesElement.innerText = dates;

        const venueElement = document.getElementById("upcomingVenue");
        populateVenue(venueElement, venue);

        const bptElement = document.getElementById("upcomingBptWidget");
        populateBrownPaperTicketsWidget(bptElement, bptId);

        const descriptionElement = document.getElementById("upcomingDescription");
        descriptionElement.innerHTML = show.description;

        const ticketTierListElement = document.getElementById("upcomingTicketTiers");
        populateTicketTiers(ticketTierListElement, ticketTiers);

        const showtimesListElement = document.getElementById("upcomingShowtimes")
        populateShowtimes(showtimesListElement, showtimes);

        const castListElement = document.getElementById("upcomingCastList");
        populateCastList(castListElement, emcee, highlights, companyMembers);
      }

      function populatePriorPerformances(priorPerformancesList, show) {
        const template = document.getElementById("priorPerformanceTemplate");

        const hasUpcomingPerformance = checkForUpcomingPerformance(show);
        const hasPriorPerformances = checkForPriorPerformances(show);
        
        let performanceIndex = hasUpcomingPerformance ? 1 : 0;
        while (performanceIndex < show.performances.length) {
          const { dates, venue, emcee, highlights, companyMembers } = show.performances[performanceIndex];
          const priorPerformanceElement = template.content.firstElementChild.cloneNode(true);
          priorPerformancesList.append(priorPerformanceElement);

          const datesElement = priorPerformanceElement.querySelector(".show-dates")
          datesElement.innerText = dates;

          const venueElement = priorPerformanceElement.querySelector('a[name="venue"]')
          populateVenue(venueElement, venue);

          const castListElement = priorPerformanceElement.querySelector(".cast-list")
          populateCastList(castListElement, emcee, highlights, companyMembers);
          
          performanceIndex++;
        }
      }
      
      function populatePage() {
        const url = new URL(document.location);
        const showId = url.searchParams.get("showId");

        const mainElement = document.getElementById("main");

        // check for valid show
        if (showId && shows[showId]) {
          const show = shows[showId];

          const headerImage = document.getElementById("headerImage");
          headerImage.setAttribute("src", `/assets/shows/${showId}/header.small.jpg`)
          headerImage.setAttribute("alt", `Header image for ${show.name}`);
          
          const nameElement = document.getElementById("name");
          nameElement.innerText = show.name;

          if (show.performances && show.performances.length > 0){
            const hasUpcomingPerformance = checkForUpcomingPerformance(show);
            const hasPriorPerformances = checkForPriorPerformances(show);

            const upcomingPerformanceElement = document.getElementById("upcomingPerformance");
            if (hasUpcomingPerformance) {
              populateUpcomingPerformance(show);
            } else {
              upcomingPerformanceElement.hidden = true;
              const descriptionElement = document.getElementById("priorPerformancesDescription");
              descriptionElement.innerHTML = show.description;
            }

            if (hasPriorPerformances) {

              if (hasUpcomingPerformance) {
                const priorPerformancesHeadingElement = document.getElementById("priorPerformancesHeading");
                priorPerformancesHeadingElement.hidden = false;
              }
              
              const priorPerformanceList = document.getElementById("priorPerformancesList")
              populatePriorPerformances(priorPerformanceList, show);
            }

            if (show.videos && show.videos.length > 0){
              console.log(JSON.stringify(show.videos))
              show.videos.forEach(video => {
                const teaserVideo = document.createElement("div")
                teaserVideo.setAttribute("class", "performance-clip");
                teaserVideo.append(generateYouTubeEmbed({ id: video.id, aspectRatio:video.aspectRatio}));
                mainElement.append(teaserVideo);
              })
            }
          } else {
            mainElement.innerHTML = "This show has no performances";
          }
        } else {
          mainElement.innerHTML = "Show not found";
        }
      }

      populatePage();
    </script>

  </head>
  <body>
    <div class="bodyWrapper">
      <header id="header"></header>
      <div class="header-image"><img id="headerImage" /></div>
      <main id="main">
        <h1 id="name"></h1>

        <div id="upcomingPerformance">
          <h2 id="upcomingDates" class="show-dates"></h2>
          <h3 class="venue"><a id="upcomingVenue"></a></h3>
          <div id="upcomingBptWidget" class="tickets"></div>
          <p id="upcomingDescription"></p>
          <ul id="upcomingTicketTiers" class="ticket-tiers"></ul>
          <ul id="upcomingShowtimes" class="show-times"></ul>
          <ul id="upcomingCastList" class="cast-list"></ul>
        </div>

        <div id="priorPerformances">
          <p id="priorPerformancesDescription"></p>
          <h2 id="priorPerformancesHeading" hidden>Prior Performances</h2>
          <ul id="priorPerformancesList">
            <template id="priorPerformanceTemplate">
              <li>
                <h2 class="show-dates"></h2>
                <h3 class="venue"><a name="venue"></a></h3>
                <ul class="cast-list"></ul>
              </li>
            </template>
          </ul>
        </div>

        <div id="showVideos"></div>

      </main>
      <footer id="footer"></footer>
    </div>
  </body>
</html>